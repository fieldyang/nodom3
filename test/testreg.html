<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
    let reg = /('.*?')|(".*?")|(`.*?`)/g;
    // let s = `zz + foo1 ( $foo2(xx,'123')+ Math.floor(yy)+20)+ 'xxff' +   123`;
    let s = `$date(date1,'yyyy-MM-dd HH:mm:ss')`;
    let fields = [];
    let r;
    let st=0;
    while((r=reg.exec(s))!==null){
        if(r.index>st){
            let tmp = s.substring(st,r.index);
            let s1 = handle(tmp);
            console.log(tmp,r);
            s = s.substring(0,st) + s1 + r[0] + s.substr(reg.lastIndex);
            reg.lastIndex = st + s1.length + r[0].length;
        }
        st = reg.lastIndex;
    }
    console.log(fields,s);
    let xx = 10;
    let yy = 20.5;
    let zz = 30;
    let func = new Function('return(' + s + ')');
    let foo;
    console.log(func)
    console.log(func());
    
    function handle(s){
        let reg = /[$a-zA-Z_][$\w\d\.]+(\s*\()?/g;
        let r;
        let st = 0;
        while((r=reg.exec(s))!== null){
            if(r[0].endsWith('(')){
                let fos = handleFunc(r[0]);
                s = s.substring(0,r.index) + fos + s.substr(reg.lastIndex);
                reg.lastIndex = r.index + fos.length;
                st = reg.lastIndex;
            }else{
                fields.push(r[0]);
            }
        }
        // console.log(s);
        return s;
    }

    function handleFunc(s){
        let mName = s.substring(0,s.length-1).trim();
        if(mName.indexOf('.') === -1){
            // return '(' + mName +  '|| $module.getMethod("' + mName + '"))' + '(';
            // return '(foo||' + mName + ')' + '(';
            // return '(foo?foo:' + mName + ')(';
            return " ($module.getMethod('" + mName +  "')||" + mName + ')(';
            
        }
        return mName + '('
    }

    function foo1(s){
        return s;
    }

    function $foo2(a,b){
        return a + '_' + b;
    }
</script>
</html>